<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InventaLab â€” AI Research Session</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f5f4ff',
              100: '#eeeaff',
              300: '#bfb3ff',
              500: '#6b58ff',
              600: '#5a49f0'
            },
            muted: '#6b7280'
          },
          borderRadius: {
            'lg-2': '18px'
          },
          boxShadow: {
            'soft-lg': '0 10px 30px rgba(13, 18, 35, 0.06)'
          }
        }
      }
    }
  </script>

  <!-- Mermaid for mind-map rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false, theme: 'default' })</script>

  <!-- Marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { -webkit-font-smoothing:antialiased; }
    .typing-cursor { display:inline-block; width:4px; height:18px; background:#111827; margin-left:3px; animation: blink 1s step-start 0s infinite; vertical-align:middle; }
    @keyframes blink { 50% { opacity: 0 } }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .bubble-user { background: linear-gradient(180deg,#eef0ff,#f6f5ff); }
    .bubble-assistant { background: #fff; }
    
    /* Markdown styling */
    .prose h1 { font-size: 1.5rem; font-weight: 700; margin: 1rem 0 0.5rem 0; }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin: 1rem 0 0.5rem 0; }
    .prose h3 { font-size: 1.1rem; font-weight: 600; margin: 0.75rem 0 0.5rem 0; }
    .prose p { margin: 0.5rem 0; line-height: 1.6; }
    .prose ul, .prose ol { margin: 0.5rem 0; padding-left: 1.5rem; }
    .prose li { margin: 0.25rem 0; }
    .prose code { background: #f3f4f6; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.875rem; }
    .prose strong { font-weight: 600; }
    .prose em { font-style: italic; }
  </style>
</head>
<body class="bg-gradient-to-b from-white to-[#fbfbff] text-[#0b1220] antialiased">

  <main class="max-w-xl mx-auto px-4 safe-bottom pb-36">

    <!-- Header -->
    <header class="flex items-center justify-between py-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full flex items-center justify-center bg-gradient-to-br from-brand-100 to-brand-300 shadow-soft-lg">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-95">
            <path d="M12 2l1.7 3.6L17.6 7 14 9.2 14.9 13 12 11.2 9.1 13 10 9.2 6.4 7 10.3 5.6 12 2z" fill="#4f46e5"/>
          </svg>
        </div>
        <div class="font-semibold text-lg">InventaLab</div>
      </div>

      <div class="text-sm text-muted flex items-center gap-3">
        <div id="agendaBadge" class="px-3 py-1 rounded-full bg-[#f4f3ff]">Research Session</div>
      </div>
    </header>

    <!-- Session header -->
    <section class="bg-white rounded-lg-2 p-4 shadow-soft-lg">
      <div class="flex items-start gap-3">
        <div class="flex-1">
          <h1 class="text-xl font-extrabold">AI Thinking Engine â€” Research Session</h1>
          <p class="mt-2 text-sm text-muted">You will be guided through micro-questions, mind-maps, and invention prompts. Create your Invention Log to complete the research.</p>
        </div>
        <div class="w-20 hidden md:block">
          <svg viewBox="0 0 520 520" class="w-20 h-20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><radialGradient id="g" cx="40%" cy="35%"><stop offset="0" stop-color="#fff"/><stop offset="0.6" stop-color="#e9e7ff"/><stop offset="1" stop-color="#d3cfff"/></radialGradient></defs>
            <g transform="translate(20,40) scale(0.9)"><ellipse cx="360" cy="180" rx="140" ry="40" fill="none" stroke="#dcd6ff" stroke-width="16" transform="rotate(-18 360 180)"/><path d="M140 20c-40-10-110 12-118 78-8 66 30 120 84 124 54 4 86-44 114-76 28-32 24-92-36-120-20-9-42-14-44-6z" fill="url(#g)"/></g>
          </svg>
        </div>
      </div>
    </section>

    <!-- Chat and controls -->
    <section id="chatArea" class="mt-4 space-y-4">

      <!-- Chat history -->
      <div id="messages" class="space-y-3"></div>

      <!-- Micro-questions / quick prompts -->
      <div id="microQ" class="flex gap-2 flex-wrap"></div>

      <!-- Mermaid mindmap panel -->
      <div id="mermaidPanel" class="bg-white rounded-lg-2 p-4 shadow-soft-lg hidden">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-semibold flex items-center gap-2">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/>
            </svg>
            Mind Map
          </div>
          <button id="closeMermaid" class="text-xs text-muted hover:text-gray-900">âœ• Close</button>
        </div>
        <div id="mermaidContainer" class="overflow-x-auto"></div>
      </div>

      <!-- Sources panel -->
      <div id="sourcesPanel" class="bg-white rounded-lg-2 p-4 shadow-soft-lg hidden">
        <div class="flex items-center gap-2 mb-3">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
          </svg>
          <div class="text-sm font-semibold">Sources</div>
        </div>
        <div id="sourcesList" class="space-y-2 text-sm"></div>
      </div>

      <!-- Invention preview -->
      <div id="inventionPreview" class="bg-white rounded-lg-2 p-4 shadow-soft-lg hidden">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="font-semibold">ðŸŽ¯ Invention Challenge</h3>
            <p class="text-sm text-muted mt-1" id="inventionPromptText"></p>
          </div>
          <button id="startInvention" class="px-3 py-2 bg-brand-100 hover:bg-brand-200 rounded-lg text-sm font-semibold transition-colors">Start</button>
        </div>
      </div>

    </section>

  </main>

  <!-- Sticky input area -->
  <form id="chatForm" class="fixed left-0 right-0 bottom-0 p-4 bg-white/90 backdrop-blur-md border-t border-t-[#f1eefb]">
    <div class="max-w-xl mx-auto flex gap-2 items-center">
      <input id="userInput" class="flex-1 px-4 py-3 rounded-full border border-[#f1eefb] focus:outline-none focus:border-brand-300" placeholder="Type your thought or answer a micro-question..." />
      <button id="sendBtn" type="submit" class="px-4 py-3 rounded-full bg-gradient-to-br from-brand-500 to-brand-600 text-white font-semibold hover:from-brand-600 hover:to-brand-700 transition-all">Send</button>
    </div>
  </form>

  <!-- Invention modal -->
  <div id="inventionModal" class="fixed inset-0 flex items-end md:items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black/40" id="inventionBackdrop"></div>
    <div class="relative w-full md:w-3/4 bg-white rounded-t-2xl md:rounded-2xl p-4 max-h-[80vh] overflow-auto">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Create Invention Log</div>
        <button id="closeInvModal" class="text-muted hover:text-gray-900">âœ•</button>
      </div>
      <div class="mt-3">
        <input id="invTitle" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-brand-300" placeholder="Invention title (e.g. Deadlock-free Hospital Scheduler)" />
        <textarea id="invContent" rows="8" class="w-full mt-3 px-3 py-2 border rounded-lg focus:outline-none focus:border-brand-300" placeholder="Describe your invention, diagrams, steps..."></textarea>
        <div class="flex gap-2 mt-3">
          <button id="saveInv" class="px-4 py-2 bg-brand-500 text-white rounded-lg font-semibold hover:bg-brand-600 transition-colors">Save</button>
          <button id="exportInv" class="px-4 py-2 bg-[#eef0ff] rounded-lg font-semibold hover:bg-brand-100 transition-colors">Export (copy)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-40 hidden bg-[#111827] text-white text-sm px-4 py-2 rounded-lg shadow-lg transition-all">Saved</div>

  <script>
    /* =========================================
       CONFIG - BACKEND INTEGRATION
    ========================================= */
    const API_BASE = "http://localhost:3001";
    let SESSION_ID = null;

    /* =========================================
       UTILITY FUNCTIONS
    ========================================= */
    function showToast(msg='Saved') {
      const t = document.getElementById('toast');
      t.textContent = msg; 
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), 1600);
    }

    function escapeHtml(unsafe) {
      return (unsafe || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    /* =========================================
       MESSAGE RENDERING
    ========================================= */
    const messagesEl = document.getElementById('messages');
    
    function renderUser(text) {
      const div = document.createElement('div');
      div.className = 'flex justify-end';
      div.innerHTML = `<div class="max-w-[82%] p-3 rounded-2xl bubble-user text-sm">${escapeHtml(text)}</div>`;
      messagesEl.appendChild(div);
      scrollBottom();
    }

    function renderAI(data) {
      const div = document.createElement('div');
      div.className = 'flex justify-start';
      const bubble = document.createElement('div');
      bubble.className = 'max-w-[86%] p-3 rounded-2xl bubble-assistant text-sm shadow-sm prose';
      
      // Get text content
      const textContent = data.text || data.output || '';
      
      // Parse markdown - handle both cases
      let htmlContent = '';
      if (typeof marked !== 'undefined') {
        try {
          htmlContent = marked.parse(textContent);
        } catch(e) {
          console.warn('Markdown parse error:', e);
          htmlContent = textContent.replace(/\n/g, '<br>');
        }
      } else {
        htmlContent = textContent.replace(/\n/g, '<br>');
      }
      
      bubble.innerHTML = htmlContent;
      div.appendChild(bubble);
      messagesEl.appendChild(div);
      
      // Handle mind map
      if (data.mindmap) {
        showMermaid(data.mindmap);
      }
      
      // Handle sources
      if (data.sources && data.sources.length > 0) {
        showSources(data.sources);
      }
      
      // Handle micro-questions
      if (data.microQuestions && data.microQuestions.length > 0) {
        renderMicroQuestions(data.microQuestions);
      }
      
      scrollBottom();
    }

    function scrollBottom() {
      setTimeout(() => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }, 100);
    }

    /* =========================================
       MERMAID RENDERING
    ========================================= */
    let mermaidCounter = 0;
    function showMermaid(code) {
      const container = document.getElementById('mermaidContainer');
      mermaidCounter++;
      
      // Create fresh div for each mermaid render
      const mermaidDiv = document.createElement('div');
      mermaidDiv.className = 'mermaid';
      mermaidDiv.id = `mermaid-${mermaidCounter}`;
      mermaidDiv.textContent = code;
      
      // Clear old content and add new
      container.innerHTML = '';
      container.appendChild(mermaidDiv);
      
      document.getElementById('mermaidPanel').classList.remove('hidden');
      
      try { 
        mermaid.init(undefined, `#mermaid-${mermaidCounter}`); 
      } catch(e) { 
        console.warn('Mermaid render error:', e);
        container.innerHTML = '<div class="text-xs text-red-500">Unable to render mind map. Try refreshing the page.</div>';
      }
    }

    document.getElementById('closeMermaid').addEventListener('click', ()=> {
      document.getElementById('mermaidPanel').classList.add('hidden');
    });

    /* =========================================
       SOURCES RENDERING
    ========================================= */
    function showSources(sources) {
      const container = document.getElementById('sourcesList');
      container.innerHTML = '';
      
      sources.forEach((source, idx) => {
        const div = document.createElement('div');
        div.className = 'p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
        div.innerHTML = `
          <div class="flex items-start gap-2">
            <span class="text-brand-500 font-semibold text-xs">${idx + 1}.</span>
            <div class="flex-1">
              <a href="${escapeHtml(source.url || '#')}" target="_blank" class="text-brand-600 hover:text-brand-700 font-medium text-xs">
                ${escapeHtml(source.title || 'Source ' + (idx + 1))}
              </a>
              ${source.content ? `<p class="text-xs text-muted mt-1 line-clamp-2">${escapeHtml(source.content.slice(0, 100))}...</p>` : ''}
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('sourcesPanel').classList.remove('hidden');
    }

    /* =========================================
       MICRO-QUESTIONS
    ========================================= */
    function renderMicroQuestions(questions=[]) {
      const container = document.getElementById('microQ');
      container.innerHTML = '';
      questions.forEach(q => {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-2 bg-[#eef0ff] text-sm rounded-full hover:bg-brand-100 transition-colors';
        btn.textContent = q;
        btn.setAttribute('data-q', q);
        container.appendChild(btn);
      });
    }

    document.getElementById('microQ').addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-q]');
      if (!btn) return;
      const q = btn.getAttribute('data-q');
      document.getElementById('userInput').value = q;
      document.getElementById('userInput').focus();
    });

    /* =========================================
       INVENTION MODAL
    ========================================= */
    function openInventionModal() {
      document.getElementById('inventionModal').classList.remove('hidden');
      const p = document.getElementById('inventionPromptText').textContent || '';
      document.getElementById('invTitle').value = p.slice(0,60) || 'My invention';
      document.getElementById('invContent').value = (p ? 'Idea: ' + p + '\n\nNotes:\n' : '');
    }

    function closeInventionModal() { 
      document.getElementById('inventionModal').classList.add('hidden'); 
    }

    function saveInvention() {
      const title = document.getElementById('invTitle').value.trim();
      const content = document.getElementById('invContent').value.trim();
      if (!title || !content) { 
        alert('Please add title & content'); 
        return; 
      }
      const logs = JSON.parse(localStorage.getItem('inventionLogs') || '[]');
      logs.unshift({ 
        id: Date.now(), 
        sessionId: SESSION_ID, 
        title, 
        content, 
        created: new Date().toISOString() 
      });
      localStorage.setItem('inventionLogs', JSON.stringify(logs));
      closeInventionModal();
      showToast('Invention saved âœ“');
    }

    document.getElementById('startInvention').addEventListener('click', openInventionModal);
    document.getElementById('closeInvModal').addEventListener('click', closeInventionModal);
    document.getElementById('inventionBackdrop').addEventListener('click', closeInventionModal);
    document.getElementById('saveInv').addEventListener('click', saveInvention);
    document.getElementById('exportInv').addEventListener('click', () => {
      navigator.clipboard.writeText(document.getElementById('invContent').value || '');
      showToast('Copied to clipboard âœ“');
    });

    /* =========================================
       BACKEND INTEGRATION
    ========================================= */
    async function startSession() {
      try {
        const res = await fetch(`${API_BASE}/session/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        SESSION_ID = data.sessionId;
        
        renderAI(data);

      } catch (err) {
        renderAI({ 
          text: "âš ï¸ Failed to connect to backend. Please ensure the server is running on http://localhost:3001" 
        });
        console.error(err);
      }
    }

    async function sendToAI(message) {
      try {
        const res = await fetch(`${API_BASE}/rag/teach`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId: SESSION_ID,
            message
          })
        });

        const data = await res.json();

        // Update agenda badge if provided
        if (data.agendaStep) {
          document.getElementById('agendaBadge').textContent = data.agendaStep;
        }

        // Render AI response with all structured data
        renderAI(data);

        // Check if response contains invention prompt
        const outputText = data.text || data.output || '';
        if (outputText.toLowerCase().includes('invent') || 
            outputText.toLowerCase().includes('design') ||
            outputText.toLowerCase().includes('create your')) {
          document.getElementById('inventionPromptText').textContent = outputText.slice(0, 200);
          document.getElementById('inventionPreview').classList.remove('hidden');
        }

      } catch (err) {
        renderAI({ 
          text: "âš ï¸ Error communicating with AI professor. Please try again." 
        });
        console.error(err);
      }
    }

    /* =========================================
       FORM HANDLING
    ========================================= */
    const form = document.getElementById('chatForm');
    const input = document.getElementById('userInput');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || !SESSION_ID) return;

      renderUser(text);
      input.value = '';

      await sendToAI(text);
    });

    /* =========================================
       INITIALIZATION
    ========================================= */
    document.addEventListener("DOMContentLoaded", startSession);
  </script>

</body>
</html>